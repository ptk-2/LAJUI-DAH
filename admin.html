<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAJUI DAH - Halaman Admin</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        #container { width: 100%; max-width: 1000px; margin: auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #1c1e21; text-align: center; }
        input, select, button { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        button { background-color: #1877f2; color: white; font-weight: bold; cursor: pointer; border: none; }
        button:hover { background-color: #166fe5; }
        #logout-button, .cancel-button { background-color: #fa3e3e; }
        #logout-button:hover, .cancel-button:hover { background-color: #e03030; }
        #login-view-admin { padding: 50px 0; text-align: center; }
        #admin-login-button { max-width: 300px; }
        .tab-buttons { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-button { background: none; border: none; padding: 15px; font-size: 16px; cursor: pointer; color: #606770; border-bottom: 2px solid transparent; }
        .tab-button.active { color: #1877f2; border-bottom-color: #1877f2; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f7f8fa; }
        .action-buttons button { width: auto; padding: 6px 12px; font-size: 14px; margin-right: 5px; }
        .edit-btn { background-color: #f7b924; }
        .delete-btn { background-color: #d92550; }
        .pengajuan-item { border: 1px solid #ddd; border-radius: 6px; padding: 15px; margin-bottom: 15px; background-color: #f7f8fa; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="container">
    <div id="login-view-admin">
        <h1>Panel Admin LAJUI DAH</h1>
        <p>Silakan login untuk melanjutkan</p>
        <button id="admin-login-button">Login Sebagai Admin</button>
    </div>

    <div id="admin-dashboard" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="text-align: left;">Dasbor Admin</h2>
            <button id="logout-button" style="width: auto; padding: 10px 20px;">Logout</button>
        </div>
        
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('pegawai')">Manajemen Pegawai</button>
            <button class="tab-button" onclick="showTab('pengajuan')">Manajemen Pengajuan</button>
        </div>

        <div id="pegawai-tab">
            <h3>Form Data Pegawai</h3>
            <form id="pegawai-form">
                <input type="hidden" id="pegawai-id">
                <input type="text" id="nama-pegawai" placeholder="Nama Lengkap Pegawai" required>
                <input type="text" id="nip-pegawai" placeholder="NIP" required>
                <input type="text" id="pangkat-pegawai" placeholder="Pangkat / Golongan" required>
                <input type="text" id="jabatan-pegawai" placeholder="Jabatan" required>
                <input type="text" id="npsn-sekolah" placeholder="NPSN Sekolah" required>
                <button type="submit">Simpan Data Pegawai</button>
                <button type="button" class="cancel-button hidden" id="cancel-edit-btn">Batal Edit</button>
            </form>
            <hr style="margin: 30px 0;">
            <h3>Database Pegawai</h3>
            <table>
                <thead>
                    <tr><th>Nama</th><th>NIP</th><th>Pangkat</th><th>NPSN</th><th>Aksi</th></tr>
                </thead>
                <tbody id="pegawai-list"></tbody>
            </table>
        </div>

        <div id="pengajuan-tab" class="hidden">
            <h3>Daftar Pengajuan Masuk</h3>
            <div id="daftar-pengajuan"></div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDPUNjOaan-a92NOY9Pz_fHpKyA7tjrJiY",
      authDomain: "lajui-dah.firebaseapp.com",
      projectId: "lajui-dah",
      storageBucket: "lajui-dah.firebasestorage.app",
      messagingSenderId: "362479392989",
      appId: "1:362479392989:web:2916e9d03b607c7413a334"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- PENGATURAN LOGIN BARU ---
    // Ganti dengan password kuat yang Anda buat di Firebase Console
    const ADMIN_FIREBASE_EMAIL = "admin@lajui-dah.com"; 
    const ADMIN_FIREBASE_PASSWORD = "PasswordRahasiaFirebase123"; // <-- GANTI INI
    const POPUP_PASSWORD = "1986";

    // DOM Elements
    const loginView = document.getElementById('login-view-admin');
    const adminDashboard = document.getElementById('admin-dashboard');
    const adminLoginButton = document.getElementById('admin-login-button');
    const pegawaiForm = document.getElementById('pegawai-form');
    const pegawaiList = document.getElementById('pegawai-list');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const daftarPengajuanDiv = document.getElementById('daftar-pengajuan');

    // --- AUTH & NAVIGATION ---
    auth.onAuthStateChanged(async user => {
        if (user && user.email === ADMIN_FIREBASE_EMAIL) {
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists && userDoc.data().role === 'admin') {
                loginView.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                loadPegawai(); 
            } else {
                auth.signOut();
            }
        } else {
            loginView.classList.remove('hidden');
            adminDashboard.classList.add('hidden');
        }
    });

    // Event listener untuk tombol login baru
    adminLoginButton.addEventListener('click', () => {
        const inputPassword = prompt("Silakan masukkan password admin:");
        if (inputPassword === POPUP_PASSWORD) {
            // Jika password pop-up benar, login ke Firebase secara otomatis
            auth.signInWithEmailAndPassword(ADMIN_FIREBASE_EMAIL, ADMIN_FIREBASE_PASSWORD)
                .catch(err => {
                    alert("Gagal login ke Firebase. Pastikan akun admin sudah dibuat. Error: " + err.message);
                });
        } else if (inputPassword !== null) { // User memasukkan sesuatu tapi salah
            alert("Password yang Anda masukkan salah.");
        }
    });

    document.getElementById('logout-button').addEventListener('click', () => auth.signOut());

    function showTab(tabName) {
        document.getElementById('pegawai-tab').classList.add('hidden');
        document.getElementById('pengajuan-tab').classList.add('hidden');
        document.querySelector('.tab-button.active').classList.remove('active');
        
        document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');

        if (tabName === 'pengajuan') { loadDaftarPengajuan(); }
    }

    // --- MANAJEMEN PEGAWAI (CRUD) ---
    async function loadPegawai() {
        pegawaiList.innerHTML = '<tr><td colspan="5" style="text-align: center;">Memuat data...</td></tr>';
        const snapshot = await db.collection('pegawai').orderBy('nama').get();
        if (snapshot.empty) {
            pegawaiList.innerHTML = '<tr><td colspan="5" style="text-align: center;">Data pegawai masih kosong.</td></tr>';
            return;
        }
        pegawaiList.innerHTML = '';
        snapshot.forEach(doc => {
            const pegawai = doc.data();
            pegawaiList.innerHTML += `
                <tr>
                    <td>${pegawai.nama}</td>
                    <td>${pegawai.nip}</td>
                    <td>${pegawai.pangkat}</td>
                    <td>${pegawai.npsnSekolah}</td>
                    <td class="action-buttons">
                        <button class="edit-btn" onclick="editPegawai('${doc.id}')">Edit</button>
                        <button class="delete-btn" onclick="deletePegawai('${doc.id}')">Hapus</button>
                    </td>
                </tr>
            `;
        });
    }

    pegawaiForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('pegawai-id').value;
        const data = {
            nama: document.getElementById('nama-pegawai').value,
            nip: document.getElementById('nip-pegawai').value,
            pangkat: document.getElementById('pangkat-pegawai').value,
            jabatan: document.getElementById('jabatan-pegawai').value,
            npsnSekolah: document.getElementById('npsn-sekolah').value,
        };

        try {
            if (id) {
                await db.collection('pegawai').doc(id).update(data);
                alert('Data pegawai berhasil diperbarui!');
            } else {
                await db.collection('pegawai').add(data);
                alert('Data pegawai baru berhasil disimpan!');
            }
            pegawaiForm.reset();
            document.getElementById('pegawai-id').value = '';
            cancelEditBtn.classList.add('hidden');
            loadPegawai();
        } catch (err) { alert('Error: ' + err.message); }
    });

    async function editPegawai(id) {
        const doc = await db.collection('pegawai').doc(id).get();
        if (doc.exists) {
            const data = doc.data();
            document.getElementById('pegawai-id').value = id;
            document.getElementById('nama-pegawai').value = data.nama;
            document.getElementById('nip-pegawai').value = data.nip;
            document.getElementById('pangkat-pegawai').value = data.pangkat;
            document.getElementById('jabatan-pegawai').value = data.jabatan;
            document.getElementById('npsn-sekolah').value = data.npsnSekolah;
            cancelEditBtn.classList.remove('hidden');
            window.scrollTo(0, 0);
        }
    }

    cancelEditBtn.addEventListener('click', () => {
        pegawaiForm.reset();
        document.getElementById('pegawai-id').value = '';
        cancelEditBtn.classList.add('hidden');
    });

    async function deletePegawai(id) {
        if (confirm('Apakah Anda yakin ingin menghapus data pegawai ini?')) {
            await db.collection('pegawai').doc(id).delete();
            alert('Data berhasil dihapus.');
            loadPegawai();
        }
    }
    
    // --- MANAJEMEN PENGAJUAN ---
    async function loadDaftarPengajuan() {
        const snapshot = await db.collection('pengajuan').orderBy('tanggalPengajuan', 'desc').get();
        if(snapshot.empty){
            daftarPengajuanDiv.innerHTML = '<p>Belum ada pengajuan masuk.</p>';
            return;
        }
        daftarPengajuanDiv.innerHTML = '';
        snapshot.forEach(doc => {
            const data = doc.data();
            daftarPengajuanDiv.innerHTML += `
            <div class="pengajuan-item">
                <p><strong>Pemohon:</strong> ${data.namaPemohon} (NIP: ${data.nipPemohon})</p>
                <p><strong>Jenis:</strong> ${data.jenisLayanan}</p>
                <p><strong>No. WA:</strong> ${data.nomorWa}</p>
                <p><a href="${data.dokumenUrl}" target="_blank">Lihat Dokumen</a></p>
                <p><strong>Status:</strong> 
                    <select onchange="updateStatus('${doc.id}', this.value)">
                        <option value="Menunggu Verifikasi" ${data.status === 'Menunggu Verifikasi' ? 'selected' : ''}>Menunggu Verifikasi</option>
                        <option value="Sedang Diproses" ${data.status === 'Sedang Diproses' ? 'selected' : ''}>Sedang Diproses</option>
                        <option value="Selesai" ${data.status === 'Selesai' ? 'selected' : ''}>Selesai</option>
                        <option value="Ditolak" ${data.status === 'Ditolak' ? 'selected' : ''}>Ditolak</option>
                    </select>
                </p>
            </div>
            `;
        });
    }

    async function updateStatus(docId, newStatus) {
        await db.collection('pengajuan').doc(docId).update({ status: newStatus });
        alert('Status pengajuan berhasil diperbarui!');
    }
</script>
</body>
</html>
