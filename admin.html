<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAJUI DAH - Halaman Admin (Development)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        #container { width: 100%; max-width: 1000px; margin: auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #1c1e21; text-align: center; }
        input, select, button, a.button-style { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; text-decoration: none; display: inline-block; text-align: center; }
        button, a.button-style { background-color: #1877f2; color: white; font-weight: bold; cursor: pointer; border: none; }
        button:hover, a.button-style:hover { background-color: #166fe5; }
        .cancel-button { background-color: #fa3e3e; }
        .cancel-button:hover { background-color: #e03030; }
        .tab-buttons { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-button { background: none; border: none; padding: 15px; font-size: 16px; cursor: pointer; color: #606770; border-bottom: 2px solid transparent; }
        .tab-button.active { color: #1877f2; border-bottom-color: #1877f2; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f7f8fa; }
        .action-buttons button { width: auto; padding: 6px 12px; font-size: 14px; margin-right: 5px; }
        .edit-btn { background-color: #f7b924; }
        .delete-btn { background-color: #d92550; }
        .bulk-actions { border: 1px dashed #ccc; padding: 20px; margin-bottom: 20px; border-radius: 6px; display: flex; gap: 15px; align-items: center; }
        .bulk-actions p { margin: 0; font-size: 14px; color: #606770; flex-grow: 1; text-align: left; }
        .bulk-actions a, .bulk-actions label { margin-bottom: 0; width: auto; }
        label.button-style { background-color: #42b72a; }
        label.button-style:hover { background-color: #36a420; }
        input[type="file"] { display: none; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="container">
    <div id="admin-dashboard">
        <h2 style="text-align: center;">Dasbor Admin (Mode Pengembangan)</h2>
        
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('pegawai')">Manajemen Pegawai</button>
            <button class="tab-button" onclick="showTab('pengajuan')">Manajemen Pengajuan</button>
        </div>

        <div id="pegawai-tab">
            <div class="bulk-actions">
                <p>Gunakan template untuk menambah banyak data pegawai sekaligus.</p>
                <a href="Template_Pegawai.xlsx" download class="button-style">Download Template</a>
                <label for="upload-excel" class="button-style">Upload File Excel</label>
                <input type="file" id="upload-excel" accept=".xlsx, .xls">
            </div>

            <h3>Form Data Pegawai (Manual)</h3>
            <form id="pegawai-form">
                <input type="hidden" id="pegawai-id">
                <input type="text" id="nama-pegawai" placeholder="Nama Lengkap Pegawai" required>
                <input type="text" id="nip-pegawai" placeholder="NIP" required>
                <input type="text" id="pangkat-pegawai" placeholder="Pangkat / Golongan" required>
                <input type="text" id="jabatan-pegawai" placeholder="Jabatan" required>
                <input type="text" id="npsn-sekolah" placeholder="NPSN Sekolah" required>
                <button type="submit">Simpan Data Pegawai</button>
                <button type="button" class="cancel-button hidden" id="cancel-edit-btn">Batal Edit</button>
            </form>
            <hr style="margin: 30px 0;">
            <h3>Database Pegawai</h3>
            <table>
                <thead>
                    <tr><th>Nama</th><th>NIP</th><th>Pangkat</th><th>NPSN</th><th>Aksi</th></tr>
                </thead>
                <tbody id="pegawai-list"></tbody>
            </table>
        </div>

        <div id="pengajuan-tab" class="hidden">
            <h3>Daftar Pengajuan Masuk</h3>
            <div id="daftar-pengajuan"></div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDPUNjOaan-a92NOY9Pz_fHpKyA7tjrJiY",
      authDomain: "lajui-dah.firebaseapp.com",
      projectId: "lajui-dah",
      storageBucket: "lajui-dah.firebasestorage.app",
      messagingSenderId: "362479392989",
      appId: "1:362479392989:web:2916e9d03b607c7413a334"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM Elements
    const pegawaiForm = document.getElementById('pegawai-form');
    const pegawaiList = document.getElementById('pegawai-list');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const daftarPengajuanDiv = document.getElementById('daftar-pengajuan');
    const uploadExcelInput = document.getElementById('upload-excel');

    document.addEventListener('DOMContentLoaded', () => { loadPegawai(); });

    function showTab(tabName) {
        document.getElementById('pegawai-tab').classList.add('hidden');
        document.getElementById('pengajuan-tab').classList.add('hidden');
        document.querySelector('.tab-button.active').classList.remove('active');
        document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
        if (tabName === 'pengajuan') { loadDaftarPengajuan(); }
    }

    // --- FUNGSI UPLOAD EXCEL ---
    uploadExcelInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (jsonData.length === 0) {
                    alert('File Excel kosong atau formatnya salah.');
                    return;
                }

                // Menggunakan Batched Write untuk efisiensi
                const batch = db.batch();
                jsonData.forEach(row => {
                    const docRef = db.collection('pegawai').doc(); // Membuat dokumen baru
                    batch.set(docRef, {
                        nama: row.nama || '',
                        nip: String(row.nip || ''), // Pastikan NIP adalah string
                        pangkat: row.pangkat || '',
                        jabatan: row.jabatan || '',
                        npsnSekolah: String(row.npsnSekolah || '')
                    });
                });
                
                await batch.commit();
                alert(`${jsonData.length} data pegawai berhasil di-upload!`);
                loadPegawai(); // Muat ulang tabel

            } catch (error) {
                console.error("Error processing Excel file: ", error);
                alert("Gagal memproses file Excel. Pastikan format kolom sudah benar (nama, nip, pangkat, jabatan, npsnSekolah).");
            }
        };
        reader.readAsArrayBuffer(file);
        event.target.value = ''; // Reset input file
    });

    // --- MANAJEMEN PEGAWAI (CRUD MANUAL) ---
    async function loadPegawai() {
        pegawaiList.innerHTML = '<tr><td colspan="5" style="text-align: center;">Memuat data...</td></tr>';
        const snapshot = await db.collection('pegawai').orderBy('nama').get();
        if (snapshot.empty) {
            pegawaiList.innerHTML = '<tr><td colspan="5" style="text-align: center;">Data pegawai masih kosong.</td></tr>';
            return;
        }
        pegawaiList.innerHTML = '';
        snapshot.forEach(doc => {
            const pegawai = doc.data();
            pegawaiList.innerHTML += `
                <tr>
                    <td>${pegawai.nama}</td>
                    <td>${pegawai.nip}</td>
                    <td>${pegawai.pangkat}</td>
                    <td>${pegawai.npsnSekolah}</td>
                    <td class="action-buttons">
                        <button class="edit-btn" onclick="editPegawai('${doc.id}')">Edit</button>
                        <button class="delete-btn" onclick="deletePegawai('${doc.id}')">Hapus</button>
                    </td>
                </tr>
            `;
        });
    }

    pegawaiForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('pegawai-id').value;
        const data = {
            nama: document.getElementById('nama-pegawai').value,
            nip: document.getElementById('nip-pegawai').value,
            pangkat: document.getElementById('pangkat-pegawai').value,
            jabatan: document.getElementById('jabatan-pegawai').value,
            npsnSekolah: document.getElementById('npsn-sekolah').value,
        };
        try {
            if (id) {
                await db.collection('pegawai').doc(id).update(data);
                alert('Data pegawai berhasil diperbarui!');
            } else {
                await db.collection('pegawai').add(data);
                alert('Data pegawai baru berhasil disimpan!');
            }
            pegawaiForm.reset();
            document.getElementById('pegawai-id').value = '';
            cancelEditBtn.classList.add('hidden');
            loadPegawai();
        } catch (err) { alert('Error: ' + err.message); }
    });

    async function editPegawai(id) {
        const doc = await db.collection('pegawai').doc(id).get();
        if (doc.exists) {
            const data = doc.data();
            document.getElementById('pegawai-id').value = id;
            document.getElementById('nama-pegawai').value = data.nama;
            document.getElementById('nip-pegawai').value = data.nip;
            document.getElementById('pangkat-pegawai').value = data.pangkat;
            document.getElementById('jabatan-pegawai').value = data.jabatan;
            document.getElementById('npsn-sekolah').value = data.npsnSekolah;
            cancelEditBtn.classList.remove('hidden');
            window.scrollTo(0, 0);
        }
    }

    cancelEditBtn.addEventListener('click', () => {
        pegawaiForm.reset();
        document.getElementById('pegawai-id').value = '';
        cancelEditBtn.classList.add('hidden');
    });

    async function deletePegawai(id) {
        if (confirm('Apakah Anda yakin ingin menghapus data pegawai ini?')) {
            await db.collection('pegawai').doc(id).delete();
            alert('Data berhasil dihapus.');
            loadPegawai();
        }
    }
    
    // --- MANAJEMEN PENGAJUAN ---
    async function loadDaftarPengajuan() {
        // ... (kode ini tidak berubah) ...
    }

    async function updateStatus(docId, newStatus) {
        // ... (kode ini tidak berubah) ...
    }
</script>
</body>
</html>
